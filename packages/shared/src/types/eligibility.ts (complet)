// packages/shared/src/types/eligibility.ts

import { AidCategory } from '../constants/enums';
import { ProfileData } from './profile';
import { AidSummary } from './aid';

// ============================================================================
// OPÉRATEURS DE CONDITION
// ============================================================================

export const ConditionOperator = {
  EQUALS: '==',
  NOT_EQUALS: '!=',
  GREATER_THAN: '>',
  GREATER_THAN_OR_EQUALS: '>=',
  LESS_THAN: '<',
  LESS_THAN_OR_EQUALS: '<=',
  IN: 'in',
  NOT_IN: 'notIn',
  EXISTS: 'exists',
  NOT_EXISTS: 'notExists',
} as const;

export type ConditionOperator = (typeof ConditionOperator)[keyof typeof ConditionOperator];

// ============================================================================
// STRUCTURE DES RÈGLES D'ÉLIGIBILITÉ
// ============================================================================

export type EligibilityField = keyof ProfileData;

export type ConditionValue = string | number | boolean | string[] | number[];

export interface EligibilityCondition {
  field: EligibilityField;
  operator: ConditionOperator;
  value: ConditionValue;
  failureMessage?: string;
  successMessage?: string;
}

export type RuleLogic = 'AND' | 'OR';

export interface EligibilityRuleGroup {
  logic: RuleLogic;
  conditions: (EligibilityCondition | EligibilityRuleGroup)[];
}

export type EligibilityRules = EligibilityRuleGroup;

// ============================================================================
// STRUCTURE DES RÈGLES D'ESTIMATION
// ============================================================================

export interface FixedEstimation {
  type: 'fixed';
  amount: number;
  description?: string;
}

export interface RangeEstimation {
  type: 'range';
  min: number;
  max: number;
  description?: string;
}

export interface FormulaEstimation {
  type: 'formula';
  baseAmount: number;
  perChildBonus?: number;
  maxAmount?: number;
  minAmount?: number;
  incomeModifier?: {
    threshold: number;
    reductionPercent: number;
  };
  description?: string;
}

export type EstimationRules = FixedEstimation | RangeEstimation | FormulaEstimation;

// ============================================================================
// RÉSULTAT D'ÉVALUATION
// ============================================================================

export interface CriterionResult {
  criterion: string;
  passed: boolean;
  message: string;
  field: string;
  expected: ConditionValue;
  actual: ConditionValue;
}

export interface AidEligibilityResult {
  aidId: string;
  aid: AidSummary;
  isEligible: boolean;
  probabilityScore: number;
  estimatedAmountMin: number | null;
  estimatedAmountMax: number | null;
  criteriaResults: CriterionResult[];
  explanation: string;
}

export interface StoredEligibilityResult extends AidEligibilityResult {
  id: string;
  userProfileId: string;
  evaluatedAt: string;
}

// ============================================================================
// DTO POUR L'API
// ============================================================================

export interface EvaluateEligibilityDto {
  profileData?: ProfileData;
  profileId?: string;
  category?: AidCategory;
  aidIds?: string[];
  persistResults?: boolean;
}

export interface EligibilityEvaluationResponse {
  results: AidEligibilityResult[];
  totalAidsEvaluated: number;
  eligibleCount: number;
  evaluatedAt: string;
  persisted: boolean;
  profileId?: string;
}
