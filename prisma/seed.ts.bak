// prisma/seed.ts

import { PrismaClient } from '@prisma/client';
import * as bcrypt from 'bcrypt';
import {
  EligibilityRules,
  EstimationRules,
  AidCategory,
  GeographicScope,
} from '../packages/shared/src';

const prisma = new PrismaClient();

/**
 * Donn√©es des aides √† ins√©rer
 */
const aidsData: Array<{
  name: string;
  slug: string;
  category: AidCategory;
  shortDescription: string;
  longDescription: string;
  authority: string;
  geographicScope: GeographicScope;
  geographicZones: string[];
  eligibilityRules: EligibilityRules;
  estimationRules: EstimationRules;
  officialLink: string;
  requiredDocuments: string[];
  displayOrder: number;
}> = [
  // =====================================================================
  // AIDE 1 : APL Simplifi√©e
  // =====================================================================
  {
    name: 'Aide Personnalis√©e au Logement (APL) Simplifi√©e',
    slug: 'apl-simplifiee',
    category: 'LOGEMENT',
    shortDescription:
      'Aide mensuelle pour r√©duire le montant de votre loyer si vous √™tes locataire avec des revenus modestes.',
    longDescription: `L'Aide Personnalis√©e au Logement (APL) est une aide financi√®re destin√©e √† r√©duire le montant de votre loyer. Elle est vers√©e directement au propri√©taire et d√©duite de votre loyer. Le montant d√©pend de vos ressources, de votre situation familiale, du montant de votre loyer et de votre zone g√©ographique.

Cette version simplifi√©e illustre les crit√®res principaux d'√©ligibilit√© pour le MVP AidesMax.`,
    authority: 'CAF (Caisse d\'Allocations Familiales)',
    geographicScope: 'NATIONAL',
    geographicZones: [],
    eligibilityRules: {
      logic: 'AND',
      conditions: [
        {
          field: 'age',
          operator: '>=',
          value: 18,
          failureMessage: 'Vous devez avoir au moins 18 ans',
          successMessage: 'Crit√®re d\'√¢ge valid√© (18 ans ou plus)',
        },
        {
          field: 'housingStatus',
          operator: '==',
          value: 'LOCATAIRE',
          failureMessage: 'Cette aide est r√©serv√©e aux locataires',
          successMessage: 'Vous √™tes bien locataire',
        },
        {
          field: 'annualIncome',
          operator: '<',
          value: 30000,
          failureMessage: 'Vos revenus d√©passent le plafond de 30 000 ‚Ç¨/an',
          successMessage: 'Vos revenus sont √©ligibles (inf√©rieurs √† 30 000 ‚Ç¨/an)',
        },
      ],
    },
    estimationRules: {
      type: 'formula',
      baseAmount: 200,
      perChildBonus: 50,
      maxAmount: 450,
      incomeModifier: {
        threshold: 15000,
        reductionPercent: 25,
      },
      description: 'Montant mensuel estim√©',
    },
    officialLink:
      'https://www.caf.fr/allocataires/droits-et-prestations/s-informer-sur-les-aides/logement-et-cadre-de-vie/les-aides-au-logement',
    requiredDocuments: [
      'Pi√®ce d\'identit√©',
      'Justificatif de domicile',
      'Avis d\'imposition N-1 ou N-2',
      'Contrat de bail',
      'Attestation de loyer (cerfa)',
      'RIB',
    ],
    displayOrder: 100,
  },

  // =====================================================================
  // AIDE 2 : Ch√®que √ânergie Simplifi√©
  // =====================================================================
  {
    name: 'Ch√®que √ânergie Simplifi√©',
    slug: 'cheque-energie-simplifie',
    category: 'ENERGIE',
    shortDescription:
      'Aide annuelle pour payer vos factures d\'√©nergie (√©lectricit√©, gaz, fioul, bois) si vos revenus sont modestes.',
    longDescription: `Le ch√®que √©nergie est une aide nominative pour le paiement des factures d'√©nergie du logement. Il est envoy√© automatiquement chaque ann√©e aux m√©nages √©ligibles. Vous pouvez l'utiliser pour payer vos factures d'√©lectricit√©, de gaz, de fioul, de bois ou pour financer des travaux de r√©novation √©nerg√©tique.

Le montant d√©pend de vos revenus et de la composition de votre foyer. Cette version simplifi√©e illustre les crit√®res principaux.`,
    authority: 'Minist√®re de la Transition √âcologique',
    geographicScope: 'NATIONAL',
    geographicZones: [],
    eligibilityRules: {
      logic: 'AND',
      conditions: [
        {
          field: 'annualIncome',
          operator: '<',
          value: 11000,
          failureMessage:
            'Vos revenus d√©passent le plafond pour une personne seule (11 000 ‚Ç¨/an). Le plafond augmente avec le nombre de personnes au foyer.',
          successMessage: 'Vos revenus sont √©ligibles au ch√®que √©nergie',
        },
        {
          field: 'housingStatus',
          operator: 'in',
          value: ['LOCATAIRE', 'PROPRIETAIRE'],
          failureMessage: 'Vous devez occuper un logement (locataire ou propri√©taire)',
          successMessage: 'Vous occupez un logement √©ligible',
        },
      ],
    },
    estimationRules: {
      type: 'range',
      min: 48,
      max: 277,
      description: 'Montant annuel selon revenus et composition du foyer',
    },
    officialLink: 'https://www.chequeenergie.gouv.fr/',
    requiredDocuments: [
      'Aucun document √† fournir (envoi automatique bas√© sur la d√©claration de revenus)',
    ],
    displayOrder: 90,
  },

  // =====================================================================
  // AIDE 3 : Bourse sur Crit√®res Sociaux (BCS)
  // =====================================================================
  {
    name: 'Bourse sur Crit√®res Sociaux (BCS)',
    slug: 'bourse-criteres-sociaux',
    category: 'ETUDES',
    shortDescription:
      'Bourse d\'√©tudes pour les √©tudiants aux revenus modestes, vers√©e sur 10 mois pendant l\'ann√©e universitaire.',
    longDescription: `La bourse sur crit√®res sociaux (BCS) est accord√©e √† l'√©tudiant qui a des difficult√©s mat√©rielles pour poursuivre des √©tudes sup√©rieures. Elle est vers√©e en 10 mensualit√©s et son montant d√©pend de l'√©chelon attribu√© (de 0 bis √† 7).

L'√©chelon est calcul√© en fonction des revenus du foyer fiscal, du nombre d'enfants √† charge et de l'√©loignement entre le domicile et le lieu d'√©tudes.

Cette version simplifi√©e illustre les crit√®res principaux d'√©ligibilit√©.`,
    authority: 'CROUS (Centre R√©gional des ≈íuvres Universitaires et Scolaires)',
    geographicScope: 'NATIONAL',
    geographicZones: [],
    eligibilityRules: {
      logic: 'AND',
      conditions: [
        {
          field: 'isStudent',
          operator: '==',
          value: true,
          failureMessage: 'Cette aide est r√©serv√©e aux √©tudiants',
          successMessage: 'Vous √™tes bien inscrit comme √©tudiant',
        },
        {
          field: 'age',
          operator: '<',
          value: 28,
          failureMessage:
            'Vous devez avoir moins de 28 ans au 1er septembre de l\'ann√©e universitaire',
          successMessage: 'Crit√®re d\'√¢ge valid√© (moins de 28 ans)',
        },
        {
          field: 'annualIncome',
          operator: '<',
          value: 35000,
          failureMessage: 'Les revenus de votre foyer d√©passent les plafonds',
          successMessage: 'Revenus du foyer √©ligibles',
        },
      ],
    },
    estimationRules: {
      type: 'formula',
      baseAmount: 1200,
      perChildBonus: 400,
      maxAmount: 6335,
      minAmount: 1200,
      incomeModifier: {
        threshold: 15000,
        reductionPercent: 0,
      },
      description: 'Montant annuel (10 mensualit√©s) - √âchelon estim√© selon revenus',
    },
    officialLink: 'https://www.etudiant.gouv.fr/fr/bourses-et-aides-592',
    requiredDocuments: [
      'Pi√®ce d\'identit√©',
      'Avis d\'imposition des parents (N-2)',
      'Certificat de scolarit√© ou inscription',
      'RIB',
      'Justificatif de domicile des parents',
    ],
    displayOrder: 80,
  },

  // =====================================================================
  // AIDE 4 : ACRE Simplifi√©e
  // =====================================================================
  {
    name: 'Aide √† la Cr√©ation d\'Entreprise (ACRE Simplifi√©e)',
    slug: 'acre-simplifiee',
    category: 'BUSINESS',
    shortDescription:
      'Exon√©ration partielle de charges sociales pendant 1 an pour les cr√©ateurs et repreneurs d\'entreprise.',
    longDescription: `L'ACRE (Aide aux Cr√©ateurs et Repreneurs d'Entreprise) permet une exon√©ration partielle des charges sociales pendant les 12 premiers mois d'activit√©. Cette aide est particuli√®rement avantageuse pour les demandeurs d'emploi, les jeunes et les b√©n√©ficiaires de minima sociaux qui se lancent dans l'entrepreneuriat.

L'exon√©ration s'applique sur les cotisations d'assurance maladie, maternit√©, retraite, invalidit√©-d√©c√®s et allocations familiales.

Cette version simplifi√©e illustre les crit√®res principaux d'√©ligibilit√©.`,
    authority: 'URSSAF',
    geographicScope: 'NATIONAL',
    geographicZones: [],
    eligibilityRules: {
      logic: 'AND',
      conditions: [
        {
          field: 'hasBusinessProject',
          operator: '==',
          value: true,
          failureMessage: 'Vous devez avoir un projet de cr√©ation ou reprise d\'entreprise',
          successMessage: 'Projet de cr√©ation d\'entreprise d√©clar√©',
        },
        {
          logic: 'OR',
          conditions: [
            {
              field: 'professionalStatus',
              operator: '==',
              value: 'CHOMEUR',
              successMessage: 'Demandeur d\'emploi : √©ligible',
            },
            {
              field: 'professionalStatus',
              operator: '==',
              value: 'ETUDIANT',
              successMessage: '√âtudiant cr√©ateur : √©ligible',
            },
            {
              field: 'age',
              operator: '<',
              value: 26,
              successMessage: 'Moins de 26 ans : √©ligible',
            },
            {
              field: 'annualIncome',
              operator: '<',
              value: 12000,
              successMessage: 'B√©n√©ficiaire de minima sociaux : √©ligible',
            },
          ],
        },
      ],
    },
    estimationRules: {
      type: 'range',
      min: 2000,
      max: 8000,
      description:
        '√âconomie estim√©e sur les charges sociales la 1√®re ann√©e (selon CA pr√©visionnel)',
    },
    officialLink:
      'https://www.urssaf.fr/portail/home/independant/je-beneficie-dexonerations/acre.html',
    requiredDocuments: [
      'Formulaire de demande ACRE',
      'Justificatif de situation (attestation P√¥le Emploi, certificat de scolarit√©, etc.)',
      'Extrait Kbis ou r√©c√©piss√© de d√©claration de cr√©ation',
      'Pi√®ce d\'identit√©',
    ],
    displayOrder: 70,
  },
];

/**
 * Script de seed principal
 */
async function main() {
  console.log('üå± D√©marrage du seed...\n');

  // =====================================================================
  // 1. Cr√©ation d'un utilisateur admin
  // =====================================================================
  console.log('üë§ Cr√©ation de l\'utilisateur admin...');
  
  const adminPassword = await bcrypt.hash('Admin123!', 12);
  
  const admin = await prisma.user.upsert({
    where: { email: 'admin@aidesmax.fr' },
    update: {},
    create: {
      email: 'admin@aidesmax.fr',
      passwordHash: adminPassword,
      role: 'ADMIN',
      emailVerified: true,
      isActive: true,
    },
  });
  
  console.log(`   ‚úÖ Admin cr√©√©: ${admin.email} (id: ${admin.id})`);

  // =====================================================================
  // 2. Cr√©ation d'un utilisateur test
  // =====================================================================
  console.log('üë§ Cr√©ation de l\'utilisateur test...');
  
  const userPassword = await bcrypt.hash('User123!', 12);
  
  const testUser = await prisma.user.upsert({
    where: { email: 'test@aidesmax.fr' },
    update: {},
    create: {
      email: 'test@aidesmax.fr',
      passwordHash: userPassword,
      role: 'USER',
      emailVerified: true,
      isActive: true,
    },
  });
  
  console.log(`   ‚úÖ User test cr√©√©: ${testUser.email} (id: ${testUser.id})`);

  // =====================================================================
  // 3. Cr√©ation d'un profil pour l'utilisateur test
  // =====================================================================
  console.log('üìã Cr√©ation du profil utilisateur test...');
  
  const testProfile = await prisma.userProfile.upsert({
    where: { userId: testUser.id },
    update: {},
    create: {
      userId: testUser.id,
      age: 25,
      professionalStatus: 'SALARIE',
      familyStatus: 'CELIBATAIRE',
      childrenCount: 0,
      annualIncome: 24000,
      postalCode: '75011',
      department: '75',
      region: '√éle-de-France',
      housingType: 'APPARTEMENT',
      housingStatus: 'LOCATAIRE',
      hasRenovationProject: false,
      hasBusinessProject: false,
      isStudent: false,
    },
  });
  
  console.log(`   ‚úÖ Profil cr√©√© (id: ${testProfile.id})`);

  // =====================================================================
  // 4. Cr√©ation des aides
  // =====================================================================
  console.log('\nüì¶ Cr√©ation des aides...');
  
  for (const aidData of aidsData) {
    const aid = await prisma.aid.upsert({
      where: { slug: aidData.slug },
      update: {
        ...aidData,
        eligibilityRules: aidData.eligibilityRules as object,
        estimationRules: aidData.estimationRules as object,
      },
      create: {
        ...aidData,
        eligibilityRules: aidData.eligibilityRules as object,
        estimationRules: aidData.estimationRules as object,
      },
    });
    
    console.log(`   ‚úÖ Aide cr√©√©e: "${aid.name}" (${aid.slug})`);
  }

  console.log('\nüéâ Seed termin√© avec succ√®s !');
  console.log('\nüìù Comptes disponibles:');
  console.log('   - Admin: admin@aidesmax.fr / Admin123!');
  console.log('   - User:  test@aidesmax.fr / User123!');
}

main()
  .catch((e) => {
    console.error('‚ùå Erreur lors du seed:', e);
    process.exit(1);
  })
  .finally(async () => {
    await prisma.$disconnect();
  });
Instructions pour lancer le projet (√âtape 3.1 - 3.2)
1. Installation des d√©pendances
Bash

# √Ä la racine du projet
pnpm install
2. D√©marrage de PostgreSQL
Bash

# D√©marrer le container Docker
pnpm docker:up

# V√©rifier que Postgres est bien lanc√©
docker ps
# Vous devez voir "aidesmax-postgres" en status "healthy"
3. Configuration de l'environnement
Bash

# Copier le fichier d'exemple
cp .env.example .env

# Copier aussi pour l'API
cp apps/api/.env.example apps/api/.env
4. Build du package shared
Bash

# Builder les types partag√©s
pnpm build:shared
5. Migrations Prisma
Bash

# G√©n√©rer le client Prisma
pnpm db:generate

# Cr√©er et appliquer les migrations
pnpm db:migrate
# Nom sugg√©r√© pour la migration: "init"
6. Seed de la base de donn√©es
Bash

# Ins√©rer les donn√©es de test
pnpm db:seed
7. Lancer l'API
Bash

# En mode d√©veloppement (avec hot-reload)
pnpm dev:api

# L'API sera disponible sur http://localhost:3001/api
8. V√©rification
Bash

# Tester que l'API r√©pond
curl http://localhost:3001/api
# Devrait retourner une 404 (pas de route sur /) - c'est normal

# Visualiser la base de donn√©es (optionnel)
pnpm db:studio
R√©capitulatif √âtape 3.1 - 3.2
√âl√©ment	Fichier	Status
Package.json racine	package.json	‚úÖ
Workspace pnpm	pnpm-workspace.yaml	‚úÖ
Config TS base	tsconfig.base.json	‚úÖ
Docker Compose	docker-compose.yml	‚úÖ
Env example	.env.example	‚úÖ
Package shared	packages/shared/*	‚úÖ
Package API	apps/api/package.json	‚úÖ
Config NestJS	apps/api/nest-cli.json	‚úÖ
Main entry	apps/api/src/main.ts	‚úÖ
App module	apps/api/src/app.module.ts	‚úÖ
Config module	apps/api/src/config/configuration.ts	‚úÖ
Exception filter	apps/api/src/common/filters/http-exception.filter.ts	‚úÖ
Decorators	apps/api/src/common/decorators/*	‚úÖ
Guards	apps/api/src/common/guards/*	‚úÖ
Prisma schema	prisma/schema.prisma	‚úÖ
Prisma module	apps/api/src/modules/prisma/*	‚úÖ
Seed script	prisma/seed.ts	‚úÖ
Prochaine √©tape : 3.3 - Module Auth

Je vais maintenant impl√©menter le module d'authentification complet avec :

AuthModule, AuthController, AuthService
DTOs de validation
JWT Strategy
Endpoints register, login, me
Dois-je continuer avec l'√âtape 3.3 ?
√âtape 3.3 ‚Äì Module Auth
Vue d'ensemble
Le module Auth g√®re l'authentification des utilisateurs avec :

Inscription (register)
Connexion (login)
R√©cup√©ration du profil connect√© (me)
Fichiers √† cr√©er
